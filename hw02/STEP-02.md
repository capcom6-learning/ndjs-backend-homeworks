# –ß–∞—Å—Ç—å 2. Middleware

–î–æ–±–∞–≤–∏—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏:

1. –ñ—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤.
2. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞.
4. –í–æ–∑–≤—Ä–∞—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—à–∏–±–∫–∞—Ö –≤ –µ–¥–∏–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.

## –ñ—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤

–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ—Å—Ç—É–ø–∞—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –¥–æ–ª–∂–Ω–∞ –≤—ã–≤–æ–¥–∏—Ç—å—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å. –í—ã–≤–æ–¥–∏–º–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤–∫–ª—é—á–∞—Ç—å –≤ —Å–µ–±—è –∫–∞–∫ –º–∏–Ω–∏–º—É–º —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ª—è:

- IP-–∞–¥—Ä–µ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ú–µ—Ç–æ–¥ –∑–∞–ø—Ä–æ—Å–∞
- –ü—É—Ç—å –∑–∞–ø—Ä–æ—Å–∞
- –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
- –†–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞

–ü—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–æ 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

- –ò—Å–ø–æ–ª—å–∑—É—è https://github.com/expressjs/morgan
- –ò—Å–ø–æ–ª—å–∑—É—è https://github.com/pinojs/pino

–ë–æ–Ω—É—Å–Ω—ã–µ –∑–∞–¥–∞—á–∏:

- –ï—Å–ª–∏ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ (—Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ >= 400), —Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –≤—ã–≤–æ–¥–∏—Ç—å —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞. –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ —Ç–µ–ª–æ –Ω–µ –≤—ã–≤–æ–¥–∏—Ç—Å—è. üßë‚Äçüíªüßë‚Äçüíª

## –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä

–í —Ä–∞–º–∫–∞—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ `POST /books` –∏ `PATCH /books/:id` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –≤ –ø–æ–ª—è—Ö `cover` –∏ `file`. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ `multipart/form-data`, –∞ –Ω–µ `application/json`. –í –æ—Ç–≤–µ—Ç–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è `coverUrl` –∏ `fileUrl` —Å URL-–∞–¥—Ä–µ—Å–∞–º–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤. –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å mime-—Ç–∏–ø —Ñ–∞–π–ª–∞.

–î–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å https://github.com/expressjs/multer

–ë–æ–Ω—É—Å–Ω—ã–µ –∑–∞–¥–∞—á–∏:

- –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–æ—Ä–æ–Ω–Ω–µ–µ S3-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä, https://yandex.cloud/ru/services/storage üßë‚Äçüíª
- –í –ø–æ–ª–µ `fileUrl` –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –Ω–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–∞–π–ª, –∞ –≤–∏–¥–∞ `/books/:id/file`. –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ —Ç–∞–∫–æ–π —Å—Å—ã–ª–∫–µ 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –¥–µ–π—Å—Ç–≤–∏—è:
  - –í–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (redirect) –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ üßë‚Äçüíª
  - –í–æ–∑–≤—Ä–∞—â–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ üßë‚Äçüíªüßë‚Äçüíª
- –í –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ –ø—Ä–æ—à–ª–æ–º—É –ø—É–Ω–∫—Ç—É —Å–¥–µ–ª–∞—Ç—å –ø–æ–¥—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ —Ñ–∞–π–ª–∞–º –≤ —Ä–∞–∑—Ä–µ–∑–µ –∫–Ω–∏–≥ üßë‚Äçüíª

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

–ö —Å—É—â–Ω–æ—Å—Ç–∏ –∫–Ω–∏–≥–∏ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `userId`, —Å–æ–¥–µ—Ä–∂–∞—â–µ–µ –ò–î –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–æ–∑–¥–∞–≤—à–µ–≥–æ –∫–Ω–∏–≥—É.

–ò—Å–ø–æ–ª—å–∑—É—è middleware —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –Ω–∞–ª–∏—á–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `Authorization: Bearer <token>` –∑–∞–ø—Ä–æ—Å–∞:

| –ú–µ—Ç–æ–¥                 | –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞                                                      |
| --------------------- | ------------------------------------------------------------------ |
| `GET /books`          | –î–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–Ω–∏–≥–∏ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |
| `GET /books/:id`      | –î–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏                                      |
| `GET /books/:id/file` | –î–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º                       |
| `POST /books`         | –î–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º                       |
| `PATCH /books/:id`    | –î–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —Å–æ–∑–¥–∞–≤—à–µ–º—É –∫–Ω–∏–≥—É                     |
| `DELETE /books/:id`   | –î–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —Å–æ–∑–¥–∞–≤—à–µ–º—É –∫–Ω–∏–≥—É                     |

–ë–æ–Ω—É—Å–Ω—ã–µ –∑–∞–¥–∞—á–∏:

- –¢—Ä–µ–±–æ–≤–∞—Ç—å –Ω–µ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ª–∏—á–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞, –∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏—Å—Ö–æ–¥—è –∏–∑ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –≤ –ø–µ—Ä–≤–æ–π —á–∞—Å—Ç–∏ –ª–æ–≥–∏–∫–∏ üßë‚Äçüíª

## –í–æ–∑–≤—Ä–∞—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—à–∏–±–∫–∞—Ö –≤ –µ–¥–∏–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–∏ –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã API –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ–π –≤ –≤–∏–¥–µ JSON —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞:

```json
{
    "error": {
        "message": "string"
    }
}
```
